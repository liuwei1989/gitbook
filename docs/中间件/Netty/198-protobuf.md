### **protobuf的数据类型** {#protobuf的数据类型}

| protobuf 数据类型 | 描述 | Java 类型 |
| :--- | :--- | :--- |
| bool | 布尔类型 | boolean |
| double | 64位浮点数 | double |
| float | 32为浮点数 | float |
| int32 | 32位整数 | int |
| int64 | 无符号32位整数 | long |
| uint32 | 64位整数 | int |
| uint64 | 64为无符号整 | long |
| sint32 | 32位整数，处理负数效率更高 | int |
| sint64 | 64位整数 处理负数效率更高 | long |
| fixed32 | 32位无符号整数 | int |
| fixed64 | 64位无符号整数 | long |
| sfixed32 | 32位整数、能以更高的效率处理负数 | int |
| sfixed64 | 64为整数 | long |
| string | 只能处理 ASCII字符 | String |
| bytes | 用于处理多字节的语言字符、如中文 | ByteString |
| enum | 可以包含一个用户自定义的枚举类型uint32 | enum |
| message | 可以包含一个用户自定义的消息类型 | object of class |

### **protobuf的用法** {#protobuf的用法}

**1.几种限定符的含义**

* required: 必须赋值，不能为空，否则build一个“uninitialized” message会抛出一个RuntimeException异常，

* optional:字段可以赋值，也可以不赋值。假如没有赋值的话，会被赋上默认值。

* repeated: 该字段可以重复任意次数（包括0次），重复数据的顺序将会保存在protocol buffer中，相当于java中的List。

* 枚举：只能用指定的常量集中的一个值作为其值，枚举常量必须在32位整型值的范围内（不推荐使用负数），用分号间隔，而不是Java中的逗号。

**2.几种限定符的基本规则。**

* 在每个消息中必须至少留有一个required类型的字段。

* 每个消息中可以包含0个或多个optional类型的字段。

* repeated表示的字段可以包含0个或多个数据。需要说明的是，这一点有别于Java中的数组，因为java的数组必须包含至少一个元素。

* 兼容性： sint32和sint64是互相兼容的，但是它们与其他整数类型不兼容；string和bytes是兼容的——只要bytes是有效的UTF-8编码；嵌套消息与bytes是兼容的——只要bytes包含该消息的一个编码过的版本； fixed32与sfixed32是兼容的，fixed64与sfixed64是兼容的。

**3.分配标识号**

* 在消息定义中，每个字段都有唯一的一个数字标识符。这些标识符是用来在消息的二进制格式中识别各个字段的，一旦开始使用就不能够再改变；

* \[1,15\]之内的标识号在编码的时候会占用一个字节。\[16,2047\]之内的标识号则占用2个字节。所以应该为那些频繁出现的消息元素保留 \[1,15\]之内的标识号；

* 最小的标识号可以从1开始，最大到2^29 – 1, or 536,870,911。不可以使用其中的\[19000－19999\]的标识号， Protobuf协议实现中对这些进行了预留。如果非要在.proto文件中使用这些预留标识号，编译时就会报警。

**4.添加注释**

向.proto文件添加注释，可以使用java风格的双斜杠（//） 语法格式。

**5.嵌套类型**

你可以在其他消息类型中定义、使用消息类型，也可以将消息嵌套任意多层，组的特性已被启用，可以使用嵌套消息类型来代替组。

**6.定义服务\(Service\)**

* 如果想要将消息类型用在RPC\(远程方法调用\)系统中，可以在.proto文件中定义一个RPC服务接口，protocol buffer编译器将会根据所选择的不同语言生成服务接口代码及存根。

* 所有service类都必须实现Service接口，它提供了一种用来调用具体方法的方式，即在编译期不需要知道方法名及它的输入、输出类型。在服务器端，通过服务注册它可以被用来实现一个RPC Server

**7.扩展**

通过扩展，可以将一个范围内的字段标识号声明为可被第三方扩展所用。然后，其他人就可以在他们自己的.proto文件中为该消息类型声明新的字段，而不必去编辑原始文件了，也可以在另一个类型（嵌套类型）的范围内声明扩展。

**8.消息升级原则**

* 不要更改任何已有的字段的数值标识

* optional和repeated限定符也是相互兼容的。

* 非required的字段可以移除，但最好重命名你要删除的字段。

* 在原有的消息中，不能移除已经存在的required字段，optional和repeated类型的字段可以被移除，但是他们之前使用的标签号必须被保留，不能被新的字段重用

* 如果打算在原有消息协议中添加新的字段，同时还要保证旧版本的程序能够正常读取或写入，那么对于新添加的字段必须是optional或repeated。因为旧版本程序无法读取或写入新增的required限定符的字段。

**9.使用步骤**

* 下载protobuf.exe和protobuf.jar文件（java版），下载地址：[protobuf下载](http://code.google.com/p/protobuf/downloads/list)

* 定义用于消息文件.proto

* 使用protobuf的编译器编译消息文件

* 使用编译好对应语言的类文件进行消息的序列化与反序列化



[http://blog.csdn.net/baiye\_xing/article/details/73252827](http://blog.csdn.net/baiye_xing/article/details/73252827)

